<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating Modeling Packages With hardhat • hardhat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating Modeling Packages With hardhat">
<meta name="robots" content="noindex">
<script defer data-domain="hardhat.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hardhat</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.4.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/forge.html">Forging data for predictions</a></li>
    <li><a class="dropdown-item" href="../articles/mold.html">Molding data for modeling</a></li>
    <li><a class="dropdown-item" href="../articles/package.html">Creating Modeling Packages With hardhat</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/12/hardhat-0-1-0/">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidymodels/hardhat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Creating Modeling Packages With hardhat</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/hardhat/blob/main/vignettes/package.Rmd" class="external-link"><code>vignettes/package.Rmd</code></a></small>
      <div class="d-none name"><code>package.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/hardhat" class="external-link">hardhat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeldata.tidymodels.org" class="external-link">modeldata</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'modeldata'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:datasets':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     penguins</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">penguins</span><span class="op">)</span></span>
<span><span class="va">penguins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">penguins</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The goal of this vignette is to teach you how to use
<code><a href="../reference/mold.html">mold()</a></code> and <code><a href="../reference/forge.html">forge()</a></code> in a modeling package. This
is the intended use of these functions, even though they can also be
called interactively. Creating a new modeling package has two main
stages: creating the model fitting function, and implementing a predict
method. The stages break down like this:</p>
<ul>
<li>
<p>Stage 1 - Model Fitting</p>
<ul>
<li><p>Create a model constructor.</p></li>
<li><p>Create a fitting implementation function.</p></li>
<li><p>Create a common bridge to go between high level user facing
methods and the lower level constructor and implementation
function.</p></li>
<li><p>Create a user facing function with methods for data frame,
matrix, formula, and recipe inputs.</p></li>
</ul>
</li>
</ul>
<p>I imagine that this comes together as a few internal pieces that
power the user facing methods for your model.</p>
<p><br></p>
<p><img src="../reference/figures/Fitting.png" alt="A diagram for the functions of the model fitting stage. It shows a user  facing `model()` function connected to its methods for data.frame, matrix, recipe, and formula input. Those methods are all connected to the bridge function which in turn connects to the model implementation function and the model constructor." width="100%"></p>
<p><br></p>
<ul>
<li>
<p>Stage 2 - Model Prediction</p>
<ul>
<li><p>Create one or more prediction implementation functions, varying
by the <code>"type"</code> of prediction to make.</p></li>
<li><p>Create a common bridge between a high level predict method and
the lower level prediction implementation functions.</p></li>
<li><p>Create a user facing predict method.</p></li>
</ul>
</li>
</ul>
<p>In this case, there are 2 user facing methods. Many models have
multiple internal implementation functions that you’ll switch between,
depending on the <code>"type"</code>.</p>
<p><br></p>
<p><img src="../reference/figures/Prediction.png" alt="A diagram for the functions of the model prediction stage. It shows a user  facing `predict()` function connected to its method. The method is connected to the bridge function which in turn connects to the implementation functions for the different prediction types, here class and probability predictions." width="100%"></p>
<p><br></p>
<p>The end result is a single high level modeling function that has
methods for multiple different “interfaces”, and a corresponding predict
method to make predictions using one of these models along with new data
(by “interfaces”, I just mean the different types of inputs, so: data
frame, matrix, formula and recipe).</p>
<p>There are obviously other things that you might want your modeling
package to do. For instance, you might implement a <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>
or <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> method. But the two stages described here are
necessary for almost every model, and they involve the inputs and
outputs that hardhat helps the most with.</p>
<div class="section level3">
<h3 id="whats-our-model">What’s Our Model?<a class="anchor" aria-label="anchor" href="#whats-our-model"></a>
</h3>
<p>We will use the underlying <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> infrastructure,
<code><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit()</a></code>, to create our model. Linear regression should be
recognizable to many, so we can focus on understanding how
<code><a href="../reference/mold.html">mold()</a></code> and <code><a href="../reference/forge.html">forge()</a></code> fit in the bigger picture,
rather than trying to understand how the model works.</p>
<p><code><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit()</a></code> takes <code>x</code> and <code>y</code>
directly, rather than using the formula method. It will serve as the
core part of our modeling implementation function. More generally, it is
easiest if the core implementation function of your algorithm takes
<code>x</code> and <code>y</code> in this manner, since that is how
<code><a href="../reference/mold.html">mold()</a></code> will standardize the inputs.</p>
<p>We will call the model <code>simple_lm()</code>. It won’t have all
the features of normal linear regression (weights, offsets, etc), but
will serve as a nice dummy model to show off features you get with
hardhat.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-fitting">Model Fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<div class="section level3">
<h3 id="model-constructor">Model Constructor<a class="anchor" aria-label="anchor" href="#model-constructor"></a>
</h3>
<p>The first thing we need is a modeling <em>constructor</em>.
Constructors are very simple functions that creates new objects of our
model class. In the arguments to the constructor you supply all of the
individual pieces, and it wraps them up into a model object. The hardhat
function <code><a href="../reference/new_model.html">new_model()</a></code> can help with creating that.</p>
<p>A model constructor should:</p>
<ul>
<li><p>Have the name <code>new_&lt;model_class&gt;()</code>.</p></li>
<li><p>Take the required model elements as named arguments, including a
required <code>blueprint</code>.</p></li>
<li><p>Validate the types of the new elements.</p></li>
<li><p>Pass the named elements on to <code><a href="../reference/new_model.html">new_model()</a></code> along with
setting the class to <code>"&lt;model_class&gt;"</code>.</p></li>
</ul>
<p>If you want to learn more about the details of constructors and
creating S3 classes, take a look at the S3 section in <a href="https://adv-r.hadley.nz/s3.html#s3-constructor" class="external-link">Advanced
R</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_simple_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">coefs</span>, <span class="va">coef_names</span>, <span class="va">blueprint</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"`coefs` should be a numeric vector."</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">coef_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"`coef_names` should be a character vector."</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">coef_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"`coefs` and `coef_names` must have the same length."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/new_model.html">new_model</a></span><span class="op">(</span></span>
<span>    coefs <span class="op">=</span> <span class="va">coefs</span>, </span>
<span>    coef_names <span class="op">=</span> <span class="va">coef_names</span>,</span>
<span>    blueprint <span class="op">=</span> <span class="va">blueprint</span>, </span>
<span>    class <span class="op">=</span> <span class="st">"simple_lm"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>A <code>"simple_lm"</code> object has just enough information to make
numeric predictions on new data, but you can store other things here as
well to enable your model object to work with extra post-fitting
functionality.</p>
<p>We can test this by manually generating a model object. Along with
the custom class we provided, this object also has a
<code>"hardhat_model"</code> class. There is a very simple print method
for objects of this type. Specifically, it prints the name of the class
at the top, and only prints out the custom elements (i.e. not the
<code>blueprint</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">manual_model</span> <span class="op">&lt;-</span> <span class="fu">new_simple_lm</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"my_coef"</span>, <span class="fu"><a href="../reference/default_xy_blueprint.html">default_xy_blueprint</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">manual_model</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "my_coef"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">manual_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "coefs"      "coef_names" "blueprint"</span></span>
<span></span>
<span><span class="va">manual_model</span><span class="op">$</span><span class="va">blueprint</span></span>
<span><span class="co">#&gt; XY blueprint:</span></span>
<span><span class="co">#&gt; # Predictors: 0</span></span>
<span><span class="co">#&gt; # Outcomes: 0</span></span>
<span><span class="co">#&gt; Intercept: FALSE</span></span>
<span><span class="co">#&gt; Novel Levels: FALSE</span></span>
<span><span class="co">#&gt; Composition: tibble</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-fitting-implementation">Model Fitting Implementation<a class="anchor" aria-label="anchor" href="#model-fitting-implementation"></a>
</h3>
<p>The implementation function is where the hard work is done. I
generally recommend naming it <code>&lt;model_class&gt;_impl()</code>.
It should accept predictors and outcomes in whatever form is required
for the algorithm, run the algorithm, and return a named list of the new
elements you added to the model constructor. You might also have
arguments for extra options that can be used to tweak the internal
algorithm.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_lm_impl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">predictors</span>, <span class="va">outcomes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="va">outcomes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">coefs</span> <span class="op">&lt;-</span> <span class="va">lm_fit</span><span class="op">$</span><span class="va">coefficients</span></span>
<span>  </span>
<span>  <span class="va">coef_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">)</span></span>
<span>  <span class="va">coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">coefs</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    coefs <span class="op">=</span> <span class="va">coefs</span>,</span>
<span>    coef_names <span class="op">=</span> <span class="va">coef_names</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This simple linear regression implementation just calls
<code><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit()</a></code> with <code>x = predictors</code> and
<code>y = outcomes</code>. <code><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit()</a></code> expects a matrix of
predictors and a vector of outcomes (at least for univariate
regression). In a moment we will discuss how to create those.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">penguins</span>, select <span class="op">=</span> <span class="va">bill_length_mm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="va">penguins</span><span class="op">$</span><span class="va">body_mass_g</span></span>
<span></span>
<span><span class="fu">simple_lm_impl</span><span class="op">(</span><span class="va">predictors</span>, <span class="va">outcomes</span><span class="op">)</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1] 95.49649</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "bill_length_mm"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-fitting-bridge">Model Fitting Bridge<a class="anchor" aria-label="anchor" href="#model-fitting-bridge"></a>
</h3>
<p>Now that we have our constructor and our implementation function, we
can create a common function that will be used in all of our top level
methods (for data frames, matrices, formulas, and recipes). It will call
the implementation function, and then use that information along with
the blueprint to create a new instance of our model. It should have an
argument for the output from a call to <code><a href="../reference/mold.html">mold()</a></code>, here I’ve
called that <code>processed</code>. In that object will be (at a
minimum) the predictors, outcomes, and blueprint. You might also have
arguments for additional options to pass on to the implementation
function.</p>
<p>The bridge function should take the standardized predictors and
outcomes and convert them to the lower level types that the
implementation function requires. The <code>predictors</code> and
<code>outcomes</code> that are returned from <code><a href="../reference/mold.html">mold()</a></code> will
<em>always</em> be data frames, so in this case we can convert them to
matrices and vectors directly for use in the lower level function.</p>
<p>This is also a good place to use some of hardhat’s validation
functions. In this case, we always expect the outcome to have a single
column since this is a univariate model, so we can use
<code>validate_outcomes_is_univariate()</code> to enforce that.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_lm_bridge</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/validate_outcomes_are_univariate.html">validate_outcomes_are_univariate</a></span><span class="op">(</span><span class="va">processed</span><span class="op">$</span><span class="va">outcomes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">processed</span><span class="op">$</span><span class="va">predictors</span><span class="op">)</span></span>
<span>  <span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="va">processed</span><span class="op">$</span><span class="va">outcomes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">simple_lm_impl</span><span class="op">(</span><span class="va">predictors</span>, <span class="va">outcomes</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">new_simple_lm</span><span class="op">(</span></span>
<span>    coefs <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">coefs</span>,</span>
<span>    coef_names <span class="op">=</span> <span class="va">fit</span><span class="op">$</span><span class="va">coef_names</span>,</span>
<span>    blueprint <span class="op">=</span> <span class="va">processed</span><span class="op">$</span><span class="va">blueprint</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>At this point, we can simulate user input and pass it on to our
bridge to run a model.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate formula interface</span></span>
<span><span class="va">processed_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">bill_length_mm</span> <span class="op">~</span> <span class="va">body_mass_g</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate xy interface</span></span>
<span><span class="va">processed_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">penguins</span><span class="op">[</span><span class="st">"body_mass_g"</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">penguins</span><span class="op">$</span><span class="va">bill_length_mm</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1]  0.003754612 24.908763524 34.817525835 28.447942512</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "body_mass_g"      "speciesAdelie"    "speciesChinstrap"</span></span>
<span><span class="co">#&gt; [4] "speciesGentoo"</span></span>
<span></span>
<span><span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed_2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1] 0.01022951</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "body_mass_g"</span></span></code></pre></div>
<p>Multiple outcomes are an error:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">body_mass_g</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">multi_outcome</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `validate_outcomes_are_univariate()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> The outcome must be univariate, but 2 columns were found.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="user-facing-fitting-function">User Facing Fitting Function<a class="anchor" aria-label="anchor" href="#user-facing-fitting-function"></a>
</h3>
<p>With all of the pieces in place, we have everything we need to create
our high level modeling interface. This should be a generic function,
generally with methods for data frames, matrices, formulas, and recipes.
Each method should call <code><a href="../reference/mold.html">mold()</a></code> with the method specific
inputs to run the preprocessing, and then pass off to the bridge
function to run the actual model. It is also good practice to provide a
default method with a nice error message for unknown types.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generic</span></span>
<span><span class="va">simple_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"simple_lm"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Default</span></span>
<span><span class="va">simple_lm.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>    <span class="st">"`simple_lm()` is not defined for a '"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"'."</span>, </span>
<span>    call. <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># XY method - data frame</span></span>
<span><span class="va">simple_lm.data.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># XY method - matrix</span></span>
<span><span class="va">simple_lm.matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Formula method</span></span>
<span><span class="va">simple_lm.formula</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Recipe method</span></span>
<span><span class="va">simple_lm.recipe</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s give it a try:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="va">penguins</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bill_length_mm"</span>, <span class="st">"bill_depth_mm"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">outcomes_vec</span> <span class="op">&lt;-</span> <span class="va">penguins</span><span class="op">$</span><span class="va">body_mass_g</span></span>
<span><span class="va">outcomes_df</span> <span class="op">&lt;-</span> <span class="va">penguins</span><span class="op">[</span><span class="st">"body_mass_g"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Vector outcome</span></span>
<span><span class="fu">simple_lm</span><span class="op">(</span><span class="va">predictors</span>, <span class="va">outcomes_vec</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1] 110.88151 -40.16918</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "bill_length_mm" "bill_depth_mm"</span></span>
<span></span>
<span><span class="co"># 1 column data frame outcome</span></span>
<span><span class="fu">simple_lm</span><span class="op">(</span><span class="va">predictors</span>, <span class="va">outcomes_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1] 110.88151 -40.16918</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "bill_length_mm" "bill_depth_mm"</span></span>
<span></span>
<span><span class="co"># Formula interface</span></span>
<span><span class="fu">simple_lm</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">bill_depth_mm</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1] 110.88151 -40.16918</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "bill_length_mm" "bill_depth_mm"</span></span></code></pre></div>
<p>We can use preprocessing as well, and it is handled by
<code><a href="../reference/mold.html">mold()</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># - Log a predictor</span></span>
<span><span class="co"># - Generate dummy variables for factors</span></span>
<span><span class="fu">simple_lm</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">bill_length_mm</span><span class="op">)</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1]   3985.047 -10865.973 -11753.182 -10290.188</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "log(bill_length_mm)" "speciesAdelie"       "speciesChinstrap"   </span></span>
<span><span class="co">#&gt; [4] "speciesGentoo"</span></span>
<span></span>
<span><span class="co"># Same, but with a recipe</span></span>
<span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_log.html" class="external-link">step_log</a></span><span class="op">(</span><span class="va">bill_length_mm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="va">species</span>, one_hot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">simple_lm</span><span class="op">(</span><span class="va">rec</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1]   3985.047 -10865.973 -11753.182 -10290.188</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "bill_length_mm"    "species_Adelie"    "species_Chinstrap"</span></span>
<span><span class="co">#&gt; [4] "species_Gentoo"</span></span></code></pre></div>
<div class="section level4">
<h4 id="adding-an-intercept-option">Adding an Intercept Option<a class="anchor" aria-label="anchor" href="#adding-an-intercept-option"></a>
</h4>
<p>You might have noticed that our linear regression isn’t adding an
intercept. Generally, with linear regression models we will want a
default intercept added on. To accomplish this, we can add an
<code>intercept</code> argument to our user facing function, and then
use that to tweak the blueprint that would otherwise be created for you
automatically.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"simple_lm"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simple_lm.data.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">intercept</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">blueprint</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/default_xy_blueprint.html">default_xy_blueprint</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="va">intercept</span><span class="op">)</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, blueprint <span class="op">=</span> <span class="va">blueprint</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simple_lm.matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">intercept</span> <span class="op">=</span> <span class="cn">TRUE</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">blueprint</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/default_xy_blueprint.html">default_xy_blueprint</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="va">intercept</span><span class="op">)</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, blueprint <span class="op">=</span> <span class="va">blueprint</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simple_lm.formula</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>, <span class="va">intercept</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">blueprint</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/default_formula_blueprint.html">default_formula_blueprint</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="va">intercept</span><span class="op">)</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>, blueprint <span class="op">=</span> <span class="va">blueprint</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">simple_lm.recipe</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">data</span>, <span class="va">intercept</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">blueprint</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/default_recipe_blueprint.html">default_recipe_blueprint</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="va">intercept</span><span class="op">)</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mold.html">mold</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">data</span>, blueprint <span class="op">=</span> <span class="va">blueprint</span><span class="op">)</span></span>
<span>  <span class="fu">simple_lm_bridge</span><span class="op">(</span><span class="va">processed</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># By default an intercept is included</span></span>
<span><span class="fu">simple_lm</span><span class="op">(</span><span class="va">predictors</span>, <span class="va">outcomes_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1] 3413.45185   74.81263 -145.50718</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "(Intercept)"    "bill_length_mm" "bill_depth_mm"</span></span>
<span></span>
<span><span class="co"># But the user can turn this off</span></span>
<span><span class="fu">simple_lm</span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">bill_length_mm</span><span class="op">)</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span>, intercept <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;simple_lm&gt;</span></span>
<span><span class="co">#&gt; $coefs</span></span>
<span><span class="co">#&gt; [1]   3985.047 -10865.973 -11753.182 -10290.188</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $coef_names</span></span>
<span><span class="co">#&gt; [1] "log(bill_length_mm)" "speciesAdelie"       "speciesChinstrap"   </span></span>
<span><span class="co">#&gt; [4] "speciesGentoo"</span></span></code></pre></div>
<p>Note that even the formula method respects this
<code>intercept</code> argument. To recap, by default
<code><a href="../reference/mold.html">mold()</a></code> will <em>not</em> automatically add an intercept for
any method, including the formula method.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="model-prediction">Model Prediction<a class="anchor" aria-label="anchor" href="#model-prediction"></a>
</h2>
<div class="section level3">
<h3 id="prediction-implementation">Prediction Implementation<a class="anchor" aria-label="anchor" href="#prediction-implementation"></a>
</h3>
<p>On the prediction side, we need implementation functions like for
fitting our model. These vary based on the <code>"type"</code> argument
to <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>. The <code>"type"</code> might be
<code>"numeric"</code> for numeric predictions as we will use here, or
it could be <code>"class"</code> for hard class predictions,
<code>"prob"</code> for class probabilities, and more. A set of
recommended names for <code>"type"</code> can be found in the <a href="https://tidymodels.github.io/model-implementation-principles/model-predictions.html#input-data" class="external-link">Model
Predictions</a> section of the implementation principles.</p>
<p>For our model, we will focus on only returning numeric predictions. I
generally like to name these prediction implementation functions
<code>predict_&lt;model_class&gt;_&lt;type&gt;()</code>. The arguments
for the implementation functions should include the model object and the
predictors in the form that your prediction algorithm expects (here, a
matrix).</p>
<p>Also used here is another hardhat function for standardizing
prediction output, <code><a href="../reference/spruce.html">spruce_numeric()</a></code>. This function tidies
up the numeric response output, and automatically standardizes it to
match the recommendations in the principles guide. The output is always
a tibble, and for the <code>"numeric"</code> type it has 1 column,
<code>.pred</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_simple_lm_numeric</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">coefs</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">coefs</span></span>
<span>  </span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">predictors</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">coefs</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spruce.html">spruce_numeric</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To test it, we will have to run a model and call <code><a href="../reference/forge.html">forge()</a></code>
on the output manually. The higher level user facing function will do
this automatically.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">simple_lm</span><span class="op">(</span><span class="va">bill_length_mm</span> <span class="op">~</span> <span class="va">body_mass_g</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forge.html">forge</a></span><span class="op">(</span><span class="va">penguins</span>, <span class="va">model</span><span class="op">$</span><span class="va">blueprint</span><span class="op">)</span><span class="op">$</span><span class="va">predictors</span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">predict_simple_lm_numeric</span><span class="op">(</span><span class="va">model</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 333 × 1</span></span></span>
<span><span class="co">#&gt;    .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  39.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  39.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  37.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  38.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  38.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  42.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  36.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  39.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  41.4</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 323 more rows</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prediction-bridge">Prediction Bridge<a class="anchor" aria-label="anchor" href="#prediction-bridge"></a>
</h3>
<p>A prediction bridge converts the standardized <code>predictors</code>
into the lower level type that the prediction implementation functions
expect. <code>predictors</code> here is always a data frame, and is part
of the return value of a call to <code><a href="../reference/forge.html">forge()</a></code>. Since the
prediction implementation function takes a matrix, we convert it to that
here.</p>
<p>Additionally, it should <code><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch()</a></code> on the
<code>type</code> argument to decide which of the prediction
implementation functions to call. Here, when
<code>type == "numeric"</code>, <code>predict_simple_lm_numeric()</code>
is called.</p>
<p>I also like using <code><a href="https://rlang.r-lib.org/reference/arg_match.html" class="external-link">rlang::arg_match()</a></code> to validate that
<code>type</code> is one of the accepted prediction types. This has an
advantage over <code><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg()</a></code> in that partial matches are not
allowed, and the error messages are a bit nicer.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict_simple_lm_bridge</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">type</span>, <span class="va">object</span>, <span class="va">predictors</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">type</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/arg_match.html" class="external-link">arg_match</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"numeric"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span>,</span>
<span>    numeric <span class="op">=</span> <span class="fu">predict_simple_lm_numeric</span><span class="op">(</span><span class="va">object</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s test:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">simple_lm</span><span class="op">(</span><span class="va">bill_length_mm</span> <span class="op">~</span> <span class="va">body_mass_g</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pass in the data frame</span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forge.html">forge</a></span><span class="op">(</span><span class="va">penguins</span>, <span class="va">model</span><span class="op">$</span><span class="va">blueprint</span><span class="op">)</span><span class="op">$</span><span class="va">predictors</span></span>
<span></span>
<span><span class="fu">predict_simple_lm_bridge</span><span class="op">(</span><span class="st">"numeric"</span>, <span class="va">model</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 333 × 1</span></span></span>
<span><span class="co">#&gt;    .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  39.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  39.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  37.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  38.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  38.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  42.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  36.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  39.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  41.4</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 323 more rows</span></span></span>
<span></span>
<span><span class="co"># Partial matches are an error</span></span>
<span><span class="fu">predict_simple_lm_bridge</span><span class="op">(</span><span class="st">"numer"</span>, <span class="va">model</span>, <span class="va">predictors</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `predict_simple_lm_bridge()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> `type` must be one of "numeric", not "numer".</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you mean "numeric"?</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="user-facing-prediction-function">User Facing Prediction Function<a class="anchor" aria-label="anchor" href="#user-facing-prediction-function"></a>
</h3>
<p>Finally, we can create an S3 method for the generic
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function. To match the modeling principles, it
should use <code>new_data</code> to accept a matrix or data frame of new
predictors.</p>
<p>The first thing that the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method should do is
call <code><a href="../reference/forge.html">forge()</a></code> with the <code>new_data</code> and the
<code>blueprint</code> that we attached to our <code>simple_lm</code>
model at fit time. This performs the required preprocessing on the new
data, and checks that the <em>type</em> of the data frame supplied to
<code>new_data</code> matches the type of data frame supplied at fit
time. This is one of the most valuable features of <code><a href="../reference/forge.html">forge()</a></code>,
as it adds a large amount of robustness to your
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>ion function. You will see some examples of this
at the end of the vignette.</p>
<p>After calling <code><a href="../reference/forge.html">forge()</a></code>, it should pass off to the bridge
function to call the correct prediction function based on the type.</p>
<p>Finally, it is good practice to call the hardhat function,
<code><a href="../reference/validate_prediction_size.html">validate_prediction_size()</a></code>, with the return value and the
original <code>new_data</code> to ensure that the number of rows in the
output are the same as the number of rows of the input. If a prediction
cannot be made for a row of <code>new_data</code>, an <code>NA</code>
value should be placed there instead. Mainly, this validation function
is a check on the model developer to ensure that you always return
output with a sane length.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predict.simple_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">new_data</span>, <span class="va">type</span> <span class="op">=</span> <span class="st">"numeric"</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Enforces column order, type, column names, etc</span></span>
<span>  <span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forge.html">forge</a></span><span class="op">(</span><span class="va">new_data</span>, <span class="va">object</span><span class="op">$</span><span class="va">blueprint</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">predict_simple_lm_bridge</span><span class="op">(</span><span class="va">type</span>, <span class="va">object</span>, <span class="va">processed</span><span class="op">$</span><span class="va">predictors</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/validate_prediction_size.html">validate_prediction_size</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">new_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="final-testing">Final Testing<a class="anchor" aria-label="anchor" href="#final-testing"></a>
</h2>
<p>Finally, we can test out our top level modeling function along with
its corresponding <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">simple_lm</span><span class="op">(</span><span class="va">bill_length_mm</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">body_mass_g</span><span class="op">)</span> <span class="op">+</span> <span class="va">species</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">penguins</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 333 × 1</span></span></span>
<span><span class="co">#&gt;    .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  39.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  39.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  36.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  38.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  38.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  42.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  36.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  39.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  41.5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 323 more rows</span></span></span></code></pre></div>
<p>By using <code><a href="../reference/forge.html">forge()</a></code>, you automatically get powerful type
checking to ensure that the <code>new_data</code> is in a form that you
expect.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># `new_data` isn't a data frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">penguins</span><span class="op">$</span><span class="va">species</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `forge()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> No `forge()` method provided for a <span style="color: #0000BB;">&lt;factor&gt;</span> object.</span></span>
<span></span>
<span><span class="co"># Missing a required column</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">penguins</span>, select <span class="op">=</span> <span class="op">-</span><span class="va">body_mass_g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `forge()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> The required column <span style="color: #0000BB;">"body_mass_g"</span> is missing.</span></span>
<span></span>
<span><span class="co"># In this case, 'species' is a character, </span></span>
<span><span class="co"># but can be losslessy converted to a factor.</span></span>
<span><span class="co"># That happens for you automatically and silently.</span></span>
<span><span class="va">penguins_chr_species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">penguins</span>, species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">penguins_chr_species</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 333 × 1</span></span></span>
<span><span class="co">#&gt;    .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  39.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  39.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  36.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  38.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  38.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  42.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  36.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  39.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  41.5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 323 more rows</span></span></span>
<span></span>
<span><span class="co"># Slightly different from above. Here, 'species' is a character, </span></span>
<span><span class="co"># AND has an extra unexpected factor level. It is </span></span>
<span><span class="co"># removed with a warning, but you still get a factor </span></span>
<span><span class="co"># with the correct levels</span></span>
<span><span class="va">penguins_chr_bad_species</span> <span class="op">&lt;-</span> <span class="va">penguins_chr_species</span></span>
<span><span class="va">penguins_chr_bad_species</span><span class="op">$</span><span class="va">species</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"new_level"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">penguins_chr_bad_species</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Novel level found in column <span style="color: #0000BB;">"species"</span>: <span style="color: #0000BB;">"new_level"</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The level has been removed, and values have been coerced to <span style="color: #0000BB;">&lt;NA&gt;</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 333 × 1</span></span></span>
<span><span class="co">#&gt;    .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="color: #BB0000;">NA</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  39.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  36.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  38.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  38.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  42.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  36.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  39.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  41.5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 323 more rows</span></span></span>
<span></span>
<span><span class="co"># This case throws an error.</span></span>
<span><span class="co"># Here, 'species' is a double and</span></span>
<span><span class="co"># when it should have been a factor.</span></span>
<span><span class="co"># You can't cast a double to a factor!</span></span>
<span><span class="va">penguins_dbl_species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">penguins</span>, species <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">penguins_dbl_species</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `scream()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't convert `data$species` &lt;double&gt; to match type of `species` &lt;factor&lt;b22a0&gt;&gt;.</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://frick.ws" class="external-link">Hannah Frick</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
